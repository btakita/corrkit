# Corrkit Functional Specification

> Language-independent specification for the corrkit email sync and collaboration tool.
> This document captures the exact behavior a port must reproduce.

## 1. Overview

Corrkit syncs email threads from IMAP providers into a flat directory of Markdown files,
supports AI-assisted drafting, manages collaborator sharing via git submodules, and pushes
routing intelligence to Cloudflare.

## 2. Data Directory

### 2.1 Layout

```
{data_dir}/
  conversations/        # One .md file per thread
  drafts/               # Outgoing email drafts
  contacts/             # Per-contact context
    {name}/
      AGENTS.md
      CLAUDE.md -> AGENTS.md
  for/                  # Collaborator submodules (outgoing)
    {gh-user}/
      conversations/
      drafts/
      AGENTS.md
      CLAUDE.md -> AGENTS.md
      README.md
      voice.md
      .gitignore
  by/                   # Collaborator submodules (incoming)
    {gh-user}/
      conversations/
      drafts/
      AGENTS.md
      CLAUDE.md -> AGENTS.md
      README.md
      voice.md
      .gitignore
  manifest.toml         # Thread index (generated by sync)
  .sync-state.json      # IMAP sync state
```

### 2.2 Resolution Order

The data directory is resolved at runtime in this order:
1. `correspondence/` directory in current working directory (developer workflow)
2. `CORRKIT_DATA` environment variable
3. `~/Documents/correspondence` (general user default)

### 2.3 Config Directory

- If `correspondence/` exists in cwd → `.` (current directory, developer workflow)
- Otherwise → same as data directory (general user: config lives inside data dir)

Config files: `accounts.toml`, `collaborators.toml`, `contacts.toml`, `voice.md`, `credentials.json`

## 3. File Formats

### 3.1 Conversation Markdown

```markdown
# {Subject}

**Labels**: {label1}, {label2}
**Accounts**: {account1}, {account2}
**Thread ID**: {thread_key}
**Last updated**: {RFC 2822 date}

---

## {Sender Name} <{email}> — {RFC 2822 date}

{Body text}

---

## {Reply sender} — {date}

{Body text}
```

Metadata regex: `^\*\*(.+?)\*\*:\s*(.+)$` (multiline)
Message header regex: `^## (.+?) — (.+)$` (multiline, em dash U+2014)

Legacy format: `**Label**: {single_label}` (backward compatible, parsed if **Labels** absent)

### 3.2 Draft Markdown

```markdown
# {Subject}

**To**: {recipient}
**CC**: {optional}
**Status**: draft
**Author**: {name}
**Account**: {optional — account name from accounts.toml}
**From**: {optional — email address, used to resolve account}
**In-Reply-To**: {optional — message ID}

---

{Draft body}
```

Required fields: `# Subject` heading, `**To**`, `---` separator
Recommended fields: `**Status**`, `**Author**`
Status values: `draft` → `review` → `approved` → `sent`
Valid send statuses (for push-draft --send): `review`, `approved`

### 3.3 accounts.toml

```toml
[owner]
github_user = "username"    # Required for collaborator features
name = "Display Name"       # Optional

[accounts.{name}]
provider = "gmail"          # gmail | protonmail-bridge | imap
user = "you@gmail.com"
password = ""               # Inline password (not recommended)
password_cmd = ""           # Shell command to retrieve password
labels = ["correspondence"]
imap_host = ""              # Auto-filled by provider preset
imap_port = 993
imap_starttls = false
smtp_host = ""
smtp_port = 465
drafts_folder = "Drafts"
sync_days = 3650            # How far back to sync
default = false             # Mark one account as default

[watch]
poll_interval = 300         # Seconds between polls
notify = false              # Desktop notifications
```

Non-account top-level keys: `watch`, `owner`
Flat format (no `[accounts.]` prefix) is also supported for backward compatibility.

Password resolution order:
1. `password` field (inline)
2. `password_cmd` (run shell command, strip trailing whitespace)
3. Error if neither set

Legacy `.env` fallback: If no accounts.toml exists, reads `GMAIL_USER_EMAIL`, `GMAIL_APP_PASSWORD` (spaces stripped), `GMAIL_SYNC_LABELS` (comma-separated), `GMAIL_SYNC_DAYS` from environment.

### 3.4 collaborators.toml

```toml
[{github_username}]
labels = ["for-user"]               # Required
name = "Display Name"               # Optional
repo = "owner/to-username"          # Auto-derived if omitted
account = "personal"                # Optional — bind plain labels to one account
```

Section key = GitHub username. `repo` auto-derived as `{owner_gh}/to-{collab_gh}` if omitted.

Label scoping syntax: `account:label` (e.g. `"proton-dev:INBOX"`) binds a label to a specific account.
Plain labels use the collaborator-level `account` field, or match all accounts if unset.

### 3.5 contacts.toml

```toml
[{name}]
emails = ["addr@example.com"]
labels = ["correspondence"]         # For lookup, not sync routing
account = "personal"                # Optional
```

### 3.6 .sync-state.json

```json
{
  "accounts": {
    "{account_name}": {
      "labels": {
        "{label_name}": {
          "uidvalidity": 12345,
          "last_uid": 67890
        }
      }
    }
  }
}
```

Legacy migration: If top-level `labels` field exists and `accounts` is empty, migrate to `accounts._legacy`.

### 3.7 manifest.toml

```toml
[threads.{slug}]
subject = "Thread Subject"
thread_id = "thread key"
labels = ["label1", "label2"]
accounts = ["account1"]
last_updated = "RFC 2822 date"
contacts = ["contact-name"]
```

Generated after each sync by scanning conversation files and matching sender emails against contacts.toml.

## 4. Algorithms

### 4.1 Thread Slug Generation

```
fn slugify(text: &str) -> String:
    text = text.to_lowercase()
    text = regex_replace(r"[^a-z0-9]+", "-", text)
    text = text.trim_matches('-')
    text = text[..min(60, text.len())]
    if text.is_empty(): return "untitled"
    return text
```

Slug collisions: If `{slug}.md` exists, try `{slug}-2.md`, `{slug}-3.md`, etc.

### 4.2 Thread Key Derivation

```
fn thread_key_from_subject(subject: &str) -> String:
    regex_replace(r"^(re|fwd?):\s*", "", subject.to_lowercase().trim())
```

Strips one layer of `Re:` or `Fwd:` prefix (case-insensitive), then lowercases.

### 4.3 Message Deduplication

Messages are deduplicated by `(from, date)` tuple. If both match an existing message in the thread, the message is skipped but labels/accounts metadata is still updated.

### 4.4 Multi-Source Accumulation

When the same thread is fetched from multiple labels or accounts:
- Labels are appended (no duplicates)
- Accounts are appended (no duplicates)
- Messages are merged and deduplicated
- Messages are sorted by parsed date

### 4.5 Label Routing

Labels in `collaborators.toml` route to `{data_dir}/for/{gh_user}/conversations/`.
Plain labels (no collaborator mapping) route to `{data_dir}/conversations/`.

Account:label syntax (`"proton-dev:INBOX"`):
- Only matches when syncing the named account
- The IMAP folder used is the part after the colon

Collaborator-level `account` field:
- Plain labels only match when syncing the named account
- `account:label` labels ignore the collaborator-level account field

### 4.6 Manifest Generation

After sync, scan all `.md` files in `conversations/`:
1. Parse each file back into a Thread object
2. For each message, extract email from sender (`<email>` regex)
3. Match against contacts.toml email→name mapping
4. Write `manifest.toml` with thread metadata and matched contacts

## 5. Commands

### 5.1 init

```
corrkit init --user EMAIL [--data-dir PATH] [--provider PROVIDER]
             [--password-cmd CMD] [--labels LABEL,...] [--github-user USER]
             [--name NAME] [--sync] [--force]
```

- Creates `{data_dir}/{conversations,drafts,contacts}/` with `.gitkeep` files
- Generates `accounts.toml` with provider preset and owner section
- Creates empty `collaborators.toml` and `contacts.toml`
- `--force`: overwrite existing config; without it, exit 1 if accounts.toml exists
- `--sync`: set `CORRKIT_DATA` env, run sync
- `--provider`: `gmail` (default), `protonmail-bridge`, `imap`
- `--data-dir`: default `~/Documents/correspondence`
- `--labels`: default `correspondence` (comma-separated)

### 5.2 sync

```
corrkit sync [--full] [--account NAME]
```

Sync all configured accounts (or one with `--account`).
`--full`: ignore saved state, re-fetch all messages within `sync_days`.
Exit code: 0 on success.

### 5.3 sync-auth

```
corrkit sync-auth
```

Gmail OAuth setup. Requires `credentials.json` from Google Cloud Console.
Runs a local server on port 3000 for the OAuth callback.
Outputs the refresh token for `.env`.

### 5.4 list-folders

```
corrkit list-folders [ACCOUNT]
```

Without argument: lists available account names.
With argument: connects to IMAP and lists all folders with flags.

### 5.5 push-draft

```
corrkit push-draft FILE [--send]
```

Default: creates a draft via IMAP APPEND to the drafts folder.
`--send`: sends via SMTP. Requires Status to be `review` or `approved`.
After sending, updates Status field in the file to `sent`.

Account resolution for sending:
1. `**Account**` field → match by name in accounts.toml
2. `**From**` field → match by email address
3. Fall back to default account

### 5.6 add-label

```
corrkit add-label LABEL --account NAME
```

Text-level TOML edit to add a label to an account's `labels` array.
Preserves comments and formatting. Returns false if label already present.

### 5.7 contact-add

```
corrkit contact-add NAME --email EMAIL [--email EMAIL2] [--label LABEL] [--account ACCT]
```

Creates `{data_dir}/contacts/{name}/` with `AGENTS.md` template and `CLAUDE.md` symlink.
Updates `contacts.toml`. If both `--label` and `--account` given, adds label to account config.

### 5.8 watch

```
corrkit watch [--interval N]
```

IMAP polling daemon. Syncs all accounts, then pushes to collaborator submodules.
Desktop notifications on new messages if `notify = true` in accounts.toml.
Clean shutdown on SIGTERM/SIGINT.

### 5.9 audit-docs

```
corrkit audit-docs
```

Checks instruction files (AGENTS.md, README.md, SKILL.md) against codebase:
- Referenced paths exist on disk
- `uv run` scripts are registered
- Type conventions (msgspec, not dataclasses)
- Combined line budget (1000 lines max)
- Staleness (docs older than source)

### 5.10 help

```
corrkit help [FILTER]
corrkit --help
```

Shows command reference. Optional filter matches command names.

### 5.11 for add

```
corrkit for add GITHUB_USER --label LABEL [--name NAME] [--pat] [--public] [--account ACCT] [--org ORG]
```

Creates a private GitHub repo (`{org}/to-{gh_user}`), initializes with AGENTS.md/README.md/voice.md/conversations/drafts, adds as git submodule under `for/{gh_user}/`. Updates `collaborators.toml`.

`--pat`: PAT-based access (prints instructions instead of GitHub collaborator invite)
`--public`: public repo visibility
`--org`: override GitHub org (default: owner's github_user)

### 5.12 for sync

```
corrkit for sync [NAME]
```

For each collaborator (or one named): git pull --rebase, copy voice.md if newer, sync GitHub Actions workflow, stage+commit+push local changes, update submodule ref in parent.

### 5.13 for status

```
corrkit for status
```

Shows incoming/outgoing commit counts for each collaborator submodule.

### 5.14 for remove

```
corrkit for remove NAME [--delete-repo]
```

Deinit submodule, `git rm`, remove from collaborators.toml.
`--delete-repo`: interactively confirms, then deletes GitHub repo via `gh`.

### 5.15 for rename

```
corrkit for rename OLD NEW [--rename-repo]
```

`git mv` the directory, update collaborators.toml.
`--rename-repo`: also rename the GitHub repo via `gh repo rename`.

Searches for the directory in both `{data_dir}/for/` and `{data_dir}/by/`.

### 5.16 for reset

```
corrkit for reset [NAME] [--no-sync]
```

Pull latest, regenerate all template files (AGENTS.md, README.md, CLAUDE.md symlink, .gitignore, voice.md, notify.yml), commit, push.
`--no-sync`: regenerate files without pull/push.

### 5.17 by find-unanswered

```
corrkit by find-unanswered [--from NAME]
```

Scans `conversations/` for threads where the last message sender doesn't match `--from` (default: "Brian"). Designed to run in the collaborator's cloned repo.

Sender regex: `^## (.+?) —` (multiline, em dash)

### 5.18 by validate-draft

```
corrkit by validate-draft FILE [FILE...]
```

Validates draft files. Checks: subject heading, required fields (To), recommended fields (Status, Author), valid status value, `---` separator, non-empty body.

Exit code: 0 if all valid, 1 if any errors.

## 6. Sync Algorithm

### 6.1 State

Per-account, per-label state: `(uidvalidity: u32, last_uid: u32)`

### 6.2 Incremental Sync

For each account, for each label:
1. `SELECT` the IMAP folder
2. Check `UIDVALIDITY` — if changed from stored value, do full sync
3. If incremental: `SEARCH UID {last_uid+1}:*`, filter out `<= last_uid`
4. If full: `SEARCH SINCE {today - sync_days}`
5. For each UID: `FETCH RFC822`, parse email, merge to thread file
6. Update `(uidvalidity, last_uid)` in state

### 6.3 Message Parsing

From RFC822:
- Subject: `email.header.decode_header()` (handles encoded words)
- From: `email.header.decode_header()`
- Date: raw header string
- Body: walk multipart for `text/plain` without `Content-Disposition`, or get payload for non-multipart
- Thread key: `thread_key_from_subject(subject)`

### 6.4 Merge

For each message:
1. Find existing thread file by scanning `**Thread ID**` metadata in all `.md` files
2. If found, parse back into Thread object
3. Check dedup: `(from, date)` tuple
4. If new: append message, sort by date, update `last_date`
5. Accumulate labels and accounts
6. Write markdown, set file mtime to last message date

### 6.5 Orphan Cleanup

On `--full` sync: track all files written/updated. After sync, delete any `.md` files in `conversations/` not in the touched set.

### 6.6 State Persistence

State is saved only after all accounts complete successfully. If sync crashes mid-way, state is not saved — next run re-fetches.

## 7. Collaborator Lifecycle

### 7.1 Add

1. Create GitHub repo (`gh repo create`)
2. Add collaborator (`gh api repos/.../collaborators/...`) or print PAT instructions
3. Clone to temp dir, write template files, commit, push
4. Add as git submodule at `for/{gh_user}/`
5. Update `collaborators.toml`

### 7.2 Sync

1. `git pull --rebase` in submodule
2. Copy `voice.md` if root copy is newer
3. Sync workflow template if newer
4. Stage, commit, push local changes
5. Update submodule ref in parent (`git add {submodule_path}`)

### 7.3 Status

For each submodule:
1. `git fetch`
2. `git rev-list --count HEAD..@{u}` (incoming)
3. `git rev-list --count @{u}..HEAD` (outgoing)

### 7.4 Remove

1. `git submodule deinit -f`
2. `git rm -f`
3. Clean up `.git/modules/{path}`
4. Remove from `collaborators.toml`
5. Optionally delete GitHub repo (interactive confirmation)

### 7.5 Rename

1. Find directory in `for/` or `by/`
2. `git mv` old → new
3. Optionally `gh repo rename`
4. Update `collaborators.toml` entry

### 7.6 Reset

1. `git pull --rebase`
2. Regenerate: AGENTS.md, CLAUDE.md (symlink), README.md, .gitignore, voice.md, workflow
3. Stage, commit, push
4. Update submodule ref in parent

## 8. Draft Lifecycle

### 8.1 Create

Manual: create file in `{data_dir}/drafts/` or `{data_dir}/for/{gh_user}/drafts/`.
Filename convention: `YYYY-MM-DD-{slug}.md`.

### 8.2 Validate

`corrkit by validate-draft` checks format. See section 5.18.

### 8.3 Push / Send

`corrkit push-draft FILE`: IMAP APPEND to drafts folder.
`corrkit push-draft FILE --send`: SMTP send, update Status to `sent`.

Account resolution: Account field → From field → default account.

## 9. Watch Daemon

### 9.1 Poll Loop

```
while not shutdown:
    for each account:
        sync_account(full=false)
    save_state()
    count_new = compare uid snapshots before/after
    if count_new > 0:
        sync_collaborators()
        notify(count_new)
    wait(interval) or shutdown
```

### 9.2 Signals

SIGTERM, SIGINT → clean shutdown (finish current poll, then exit).

### 9.3 Notifications

- macOS: `osascript -e 'display notification ...'`
- Linux: `notify-send`
- Silently degrades if tool not installed.

### 9.4 Config

`[watch]` section in `accounts.toml`:
- `poll_interval`: seconds (default 300)
- `notify`: bool (default false)

CLI `--interval` overrides config.

## 10. Provider Presets

| Field | `gmail` | `protonmail-bridge` | `imap` (generic) |
|---|---|---|---|
| imap_host | imap.gmail.com | 127.0.0.1 | (required) |
| imap_port | 993 | 1143 | 993 |
| imap_starttls | false | true | false |
| smtp_host | smtp.gmail.com | 127.0.0.1 | (required) |
| smtp_port | 465 | 1025 | 465 |
| drafts_folder | [Gmail]/Drafts | Drafts | Drafts |

Preset values are defaults — any field explicitly set on the account wins.

## 11. Account Resolution

### 11.1 Password

1. `password` field (inline string)
2. `password_cmd` (shell command, capture stdout, strip trailing whitespace)
3. Raise error if neither set

### 11.2 Sending Account

For `push-draft`:
1. `**Account**` metadata field → lookup by name in accounts.toml
2. `**From**` metadata field → lookup by email address (case-insensitive)
3. Default account (first with `default = true`, or first in file)

### 11.3 Legacy .env

If no `accounts.toml` exists:
- `GMAIL_USER_EMAIL` → user
- `GMAIL_APP_PASSWORD` → password (spaces stripped)
- `GMAIL_SYNC_LABELS` → labels (comma-separated)
- `GMAIL_SYNC_DAYS` → sync_days (default 3650)
- Provider forced to `gmail` with gmail presets
- Mapped to synthetic account named `_legacy`
